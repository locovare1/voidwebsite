rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow read access to reviews
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth == null && 
        request.resource.data.keys().hasAll(['productId', 'userName', 'userEmail', 'rating', 'comment']) &&
        request.resource.data.rating is number &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5 &&
        request.resource.data.userName is string &&
        request.resource.data.userEmail is string &&
        request.resource.data.comment is string &&
        request.resource.data.productId is number;
      allow update: if request.auth == null && 
        resource.data.diff(request.resource.data).affectedKeys().hasOnly(['helpful']);
    }
  }
}